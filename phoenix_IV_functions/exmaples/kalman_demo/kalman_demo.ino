//load library
#include <phoenix_IV_functions.h>

//test data arrays
double time_stamp[] = {0,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9,0.95,1,1.05,1.1,1.15,1.2,1.25,1.3,1.35,1.4,1.45,1.5,1.55,1.6,1.65,1.7,1.75,1.8,1.85,1.9,1.95,2,2.05,2.1,2.15,2.2,2.25,2.3,2.35
,2.4,2.45,2.5,2.55,2.6,2.65,2.7,2.75,2.8,2.85,2.9,2.95,3,3.05,3.1,3.15,3.2,3.25,3.3,3.35,3.4,3.45,3.5,3.55,3.6,3.65,3.7,3.75,3.8,3.85,3.9,3.95,4,4.05,4.1,4.15,4.2,4.25,4.3,4.35,4.4,4.45,4.5,4.55,4.6,4.65,4.7,4.75,4.8,4.85,4.9,4.95};
double alt[] = {9,12,19,24,29,36,45,52,63,73,82,95,105,114,124,137,124,190,204,219,233,248,259,275,290,309,374,388,402,418,435,453,474,495,516,541,567,585,607,633,654,678,704,726,751,775,797,821,844,868,838,859,882,905,925,949,968,989,1008,1033
,1050,1072,1092,1108,1132,1150,1171,1188,1208,1227,1243,1268,1282,1297,1317,1335,1353,1368,1389,1405,1420,1435,1454,1473,1489,1505,1520,1535,1498,1514,1531,1544,1557,1577,1591,1605,1621,1633,1653,1666};
double vel[] = {180,60,140,100,100,140,180,140,220,200,180,260,200,180,200,260,-260,1320,280,300,280,300,220,320,300,380,1300,280,280,320,340,360,420,420,420,500,520,360,440,520,420,480,520,440,500,480,440,480,460,480,-600
,420,460,460,400,480,380,420,380,500,340,440,400,320,480,360,420,340,400,380,320,500,280,300,400,360,360,300,420,320,300,300,380,380,320,320,300,300,-740,320,340,260,260,400,280,280,320,240,400,260};

//necessary variables
double state[2] = {alt[0], vel[0]};
double p_cov[2][2] = {{25, 0}, {0, 25}};
int i = 1;


void setup() {
  Serial.begin(9600);
}

void loop(){
  while(i<100){
    //resource next measurement
    double measurement[2] = {alt[i], vel[i]};
    //calculate time step
    double dt = time_stamp[i] - time_stamp[i-1];
    //run kalman filter
    kalman_update(state, p_cov, measurement, dt, false, state, p_cov);

    //print data for plotting
    Serial.print(vel[i]);
    Serial.print(" ");
    Serial.println(state[1]);

    //increment counter
    i++;
    delay(100);
  }
}

